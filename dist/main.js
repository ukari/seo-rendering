"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var http=_interopDefault(require("http")),fetch=_interopDefault(require("node-fetch")),weblog=_interopDefault(require("webpack-log")),path=_interopDefault(require("path")),program=_interopDefault(require("commander"));function __async(e){return new Promise(function(t,r){function o(i,s){try{var p=e[s?"throw":"next"](i)}catch(e){return void r(e)}p.done?t(p.value):Promise.resolve(p.value).then(o,n)}function n(e){o(e,1)}o()})}let{name:name,version:version}=require("../package.json"),defaultOpts=require("../seo-config.json");const logger=weblog({name:name});let reject_service=e=>{e.writeHead(403,{Reason:"This server only serve the seo-rendering proxy service"}),e.end()},proxy=({proxyUrl:e,targetUrl:t})=>http.createServer((r,o)=>__async(function*(){if("GET"===r.method){yield fetch(e+"/"+t+r.url,{headers:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/71.0.3578.98 Chrome/71.0.3578.98 Safari/537.36"}}),yield result.text();return o.writeHead(200,{}),void o.end(result)}reject_service(o)}())),launch=({proxyUrl:e,targetUrl:t,port:r,host:o})=>proxy({proxyUrl:e,targetUrl:t}).listen(r,o,()=>{logger.info(`seo-rendering proxy launch on ${o}:${r}`),logger.info(`GET request will be redirect to ${e}/${t}`)}),options={host:defaultOpts.host,port:defaultOpts.port},setOpt=e=>t=>options[e]=t;program.name(name).version(version,"-v, --version").option("-S, --service [proxyUrl]","the headless proxy service url",setOpt("proxyUrl")).option("-T, --target [targetUrl]","the target website url",setOpt("targetUrl")).option("-H, --host [host]",`default ${options.host}, hostname of this proxy server`,setOpt("host")).option("-P, --port [port]",`default ${options.port}, port number of this proxy server`,setOpt("port")).option("-C, --config [json filename]","run with config json file",e=>{let t=require(path.join(process.cwd(),e));options={...defaultOpts,...t}}).parse(process.argv),launch(options);
